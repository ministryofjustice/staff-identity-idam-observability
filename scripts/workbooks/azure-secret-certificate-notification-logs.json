{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let expiredCredentialsCount=toscalar(\r\n    AppRegistrationExpiration_CL\r\n    | where Status == 'Expired'\r\n    | summarize arg_max(KeyId, *) by KeyId\r\n    | count);\r\nlet appIdsWithActiveCertificates=\r\n    AppRegistrationExpiration_CL\r\n        | where Status == 'Valid'\r\n        | project ApplicationId;\r\nlet appRegWithNoValidCredentialCount=toscalar(\r\n    AppRegistrationExpiration_CL\r\n    | where ApplicationId !in (appIdsWithActiveCertificates)\r\n    | summarize arg_max(DisplayName, *) by DisplayName\r\n    | count);\r\nlet expiringIn30Days=toscalar(\r\nAppRegistrationExpiration_CL\r\n| where Status == 'Valid'\r\n| where DaysToExpiration > 0 and DaysToExpiration < 30\r\n| summarize arg_max(KeyId, *) by KeyId\r\n| count);\r\nlet dayStringMapping = \r\nunion (print Name = \"App Registrations with no valid credentials\", Count = appRegWithNoValidCredentialCount),\r\n        (print Name = \"No. of expired credentials\", Count = expiredCredentialsCount),\r\n        (print Name = \"Expiring in the next 30 Days\", Count = expiringIn30Days);\r\ndayStringMapping",
        "size": 4,
        "title": "Expired Credentials Count",
        "timeContext": {
          "durationMs": 259200000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/b1426ee9-0bcd-42e8-876a-794707804ea3/resourceGroups/rg-aad-appmonitoring-001/providers/Microsoft.OperationalInsights/workspaces/azure-secret-certificate-notification-logs"
        ],
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "Name",
            "formatter": 1
          },
          "subtitleContent": {
            "columnMatch": "Count",
            "formatter": 12,
            "formatOptions": {
              "palette": "blue"
            }
          },
          "showBorder": true,
          "size": "auto"
        }
      },
      "name": "Expired Credentials Count"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "AppRegistrationExpiration_CL\r\n| where Status == 'Valid'\r\n| where DaysToExpiration > 0 and DaysToExpiration < 30\r\n| summarize arg_max(KeyId, *) by KeyId\r\n| project DisplayName, KeyId, ApplicationId, CredentialType = EventType, DaysToExpiration\r\n| sort by DaysToExpiration asc",
        "size": 0,
        "title": "Expiring in the next 30 Days",
        "timeContext": {
          "durationMs": 259200000
        },
        "showRefreshButton": true,
        "showExportToExcel": true,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/b1426ee9-0bcd-42e8-876a-794707804ea3/resourceGroups/rg-aad-appmonitoring-001/providers/Microsoft.OperationalInsights/workspaces/azure-secret-certificate-notification-logs"
        ]
      },
      "name": "ExpiringIn30Days"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "AppRegistrationExpiration_CL\r\n| where Status == 'Expired'\r\n| summarize arg_max(KeyId, *) by KeyId\r\n| project DisplayName, KeyId, ApplicationId, CredentialType = EventType, DaysToExpiration\r\n| sort by DaysToExpiration asc",
        "size": 0,
        "title": "Expired Credentials",
        "timeContext": {
          "durationMs": 259200000
        },
        "showRefreshButton": true,
        "showExportToExcel": true,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/b1426ee9-0bcd-42e8-876a-794707804ea3/resourceGroups/rg-aad-appmonitoring-001/providers/Microsoft.OperationalInsights/workspaces/azure-secret-certificate-notification-logs"
        ]
      },
      "name": "Expired Credentials"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let appIdsWithActiveCertificates=\r\n    AppRegistrationExpiration_CL\r\n        | where Status == 'Valid'\r\n        | project ApplicationId;\r\nAppRegistrationExpiration_CL\r\n| where ApplicationId !in (appIdsWithActiveCertificates)\r\n| summarize arg_max(DisplayName, *) by DisplayName\r\n| project DisplayName, ApplicationId, CredentialType = EventType",
        "size": 0,
        "title": "App Registrations with no valid credentials",
        "timeContext": {
          "durationMs": 259200000
        },
        "showRefreshButton": true,
        "showExportToExcel": true,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/b1426ee9-0bcd-42e8-876a-794707804ea3/resourceGroups/rg-aad-appmonitoring-001/providers/Microsoft.OperationalInsights/workspaces/azure-secret-certificate-notification-logs"
        ]
      },
      "name": "query - 2"
    }
  ],
  "fallbackResourceIds": [
    "Azure Monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
